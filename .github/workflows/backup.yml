name: Tumblr Backup

on:
  schedule:
    - cron: '0 13 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  backup:
    runs-on: ubuntu-latest
    env:
      OUTPUT_DIR: backup
      DOWNLOAD_IMAGES: true
      DOWNLOAD_VIDEOS: true
      DOWNLOAD_AUDIO: true
      INCREMENTAL_HOURS: 25
      DELETE_AFTER_BACKUP: true
      ADD_TO_YOUTUBE_PLAYLIST: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Create config.json from secrets and variables
      run: |
        cat > config.json << EOF
        {
          "blog_identifier": "${{ secrets.BLOG_IDENTIFIER }}",
          "api_key": "${{ secrets.API_KEY }}",
          "consumer_secret": "${{ secrets.CONSUMER_SECRET }}",
          "oauth_token": "${{ secrets.OAUTH_TOKEN }}",
          "oauth_token_secret": "${{ secrets.OAUTH_TOKEN_SECRET }}",
          "output_dir": "${{ env.OUTPUT_DIR }}",
          "download_images": ${{ env.DOWNLOAD_IMAGES }},
          "download_videos": ${{ env.DOWNLOAD_VIDEOS }},
          "download_audio": ${{ env.DOWNLOAD_AUDIO }},
          "incremental_hours": ${{ env.INCREMENTAL_HOURS }},
          "delete_after_backup": ${{ env.DELETE_AFTER_BACKUP }},
          "add_to_youtube_playlist": ${{ env.ADD_TO_YOUTUBE_PLAYLIST }},
          "youtube_playlist_id": "${{ secrets.YOUTUBE_PLAYLIST_ID }}",
          "youtube_client_id": "${{ secrets.YOUTUBE_CLIENT_ID }}",
          "youtube_client_secret": "${{ secrets.YOUTUBE_CLIENT_SECRET }}",
          "youtube_refresh_token": "${{ secrets.YOUTUBE_REFRESH_TOKEN }}"
        }
        EOF

    - name: Run backup
      run: |
        python tumblr_backup.py

    - name: Upload to Dropbox
      run: |
        python upload_to_dropbox.py
      env:
        DROPBOX_APP_KEY: ${{ secrets.DROPBOX_APP_KEY }}
        DROPBOX_APP_SECRET: ${{ secrets.DROPBOX_APP_SECRET }}
        DROPBOX_REFRESH_TOKEN: ${{ secrets.DROPBOX_REFRESH_TOKEN }}
        LOCAL_FOLDER: backup
        DROPBOX_PATH: /
